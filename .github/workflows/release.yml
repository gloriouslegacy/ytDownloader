name: Build and Release

on:
  push:
    branches:
      - main
    tags:
      - "v*"

jobs:
  build:
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: 8.0.x

      # ë²„ì „ ê³„ì‚°
      - name: Determine version
        id: vars
        shell: bash
        run: |
          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            base_version="${GITHUB_REF#refs/tags/v}"
            version="$base_version"
            release_name="$base_version"
          else
            version="0.0.0-dev-$(date +%Y%m%d)"
            base_version="0.0.0-dev"
            release_name="$version"
          fi
          echo "version=$version" >> $GITHUB_OUTPUT
          echo "base_version=$base_version" >> $GITHUB_OUTPUT
          echo "release_name=$release_name" >> $GITHUB_OUTPUT

      # WPF ì•± ë¹Œë“œ
      - name: Build (ytDownloader WPF)
        run: dotnet publish ytDownloader/ytDownloader.csproj -c Release -r win-x64 --self-contained false -o publish/ytDownloader -p:Version=${{ steps.vars.outputs.version }}

      # Updater ë¹Œë“œ (WPF, ì—¬ëŸ¬ íŒŒì¼ ê°•ì œ)
      - name: Build (Updater)
        # run: dotnet publish Updater/Updater.csproj -c Release -r win-x64 --self-contained false -o publish/Updater -p:Version=${{ steps.vars.outputs.version }}
        run: dotnet publish Updater/Updater.csproj -c Release -r win-x64 --self-contained true -p:PublishSingleFile=false -p:PublishTrimmed=false -o publish/Updater -p:Version=${{ steps.vars.outputs.version }}
        # run: dotnet publish Updater/Updater.csproj -c Release -r win-x64 --self-contained false -p:PublishSingleFile=false -p:PublishTrimmed=false -o publish/Updater -p:Version=${{ steps.vars.outputs.version }}
      # ë¹Œë“œ ê²°ê³¼ í™•ì¸ (ë””ë²„ê¹…ìš©)
      - name: List build output
        shell: pwsh
        run: |
          Write-Host "=== ytDownloader ë¹Œë“œ ê²°ê³¼ ==="
          Get-ChildItem publish/ytDownloader -Recurse | Format-Table Name, Length, FullName
          
          Write-Host "`n=== Updater ë¹Œë“œ ê²°ê³¼ ==="
          Get-ChildItem publish/Updater -Recurse | Format-Table Name, Length, FullName

      # ë¦´ë¦¬ìŠ¤ íŒ¨í‚¤ì§€ ì¤€ë¹„
      - name: Prepare dist
        shell: pwsh
        run: |
          mkdir dist
          # ytDownloader ZIP (Updater í¬í•¨)
          mkdir dist/ytDownloader
          Copy-Item publish/ytDownloader/* dist/ytDownloader/ -Recurse
          
          # Updater íŒŒì¼ë“¤ì„ updater ì„œë¸Œí´ë”ì— ë³µì‚¬
          mkdir dist/ytDownloader/updater
          Copy-Item publish/Updater/* dist/ytDownloader/updater/ -Recurse
          
          # ìµœì¢… êµ¬ì¡° í™•ì¸
          Write-Host "=== ìµœì¢… íŒ¨í‚¤ì§• êµ¬ì¡° ==="
          Get-ChildItem dist/ytDownloader -Recurse | Format-Table Name, Length, FullName
          
          if (Test-Path dist/ytDownloader/tools) { Remove-Item dist/ytDownloader/tools -Recurse -Force }
          Get-ChildItem dist/ytDownloader -Include *.pdb -Recurse | Remove-Item -Force
          Compress-Archive -Path dist/ytDownloader/* -DestinationPath yt_downloader_${{ steps.vars.outputs.release_name }}.zip -Force

          # Updater ZIP (ì—¬ëŸ¬ íŒŒì¼ í¬í•¨)
          mkdir dist/Updater
          Copy-Item publish/Updater/* dist/Updater/ -Recurse
          Compress-Archive -Path dist/Updater/* -DestinationPath yt_updater_${{ steps.vars.outputs.release_name }}.zip -Force

      # GitHub Release ìƒì„±
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.vars.outputs.base_version }}
          name: Release ${{ steps.vars.outputs.release_name }}
          body: |
            ğŸ“¦ ë¦´ë¦¬ìŠ¤ ì•ˆë‚´

            ë©”ì¸ í”„ë¡œê·¸ë¨: yt_downloader_${{ steps.vars.outputs.release_name }}.zip  
            â†’ ì‹¤í–‰ íŒŒì¼, í•„ìš”í•œ DLL ë° updater í´ë” í¬í•¨

            ì—…ë°ì´íŠ¸ ë„êµ¬: yt_updater_${{ steps.vars.outputs.release_name }}.zip  
            â†’ Updater.exe ë° ì‹¤í–‰ì— í•„ìš”í•œ DLL í¬í•¨ (ìˆ˜ë™ ì—…ë°ì´íŠ¸ìš©)

            âš ï¸ ì¤‘ìš”: ìë™ ì—…ë°ì´íŠ¸ ê¸°ëŠ¥ì€ ë©”ì¸ ZIPì˜ updater í´ë”ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.  
            ë³„ë„ Updater ZIPì€ ìˆ˜ë™ êµì²´ ì‹œì—ë§Œ ì‚¬ìš©í•˜ì„¸ìš”.
          files: |
            yt_downloader_${{ steps.vars.outputs.release_name }}.zip
            yt_updater_${{ steps.vars.outputs.release_name }}.zip
          prerelease: ${{ !startsWith(github.ref, 'refs/tags/') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}