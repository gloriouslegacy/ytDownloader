name: Build and Release

on:
  push:
    branches:
      - main      # main push â†’ Pre-release
    tags:
      - "v*"      # tag push (ex: v1.0.0) â†’ Release

jobs:
  build:
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: 8.0.x

      # WPF ë©”ì¸ ì•± ë¹Œë“œ
      - name: Build ytDownloader
        run: dotnet publish ytDownloader/ytDownloader.csproj -c Release -r win-x64 --self-contained false -o publish/ytDownloader

      # Updater ë¹Œë“œ (ì—¬ëŸ¬ íŒŒì¼ ì¶œë ¥)
      - name: Build Updater
        run: dotnet publish Updater/Updater.csproj -c Release -r win-x64 --self-contained false -o publish/Updater

      # ë¦´ë¦¬ìŠ¤ íŒ¨í‚¤ì§€ ì¤€ë¹„
      - name: Prepare packages
        shell: pwsh
        run: |
          mkdir dist

          # ytDownloader ì••ì¶• (Updater.exeëŠ” ì œì™¸)
          Copy-Item publish/ytDownloader/* dist/ytDownloader/ -Recurse
          if (Test-Path dist/ytDownloader/Updater.exe) { Remove-Item dist/ytDownloader/Updater.exe }
          Compress-Archive -Path dist/ytDownloader/* -DestinationPath yt_downloader_${{ github.ref_name }}.zip -Force

          # Updater ì••ì¶• (ì—¬ëŸ¬ íŒŒì¼ í¬í•¨)
          Compress-Archive -Path publish/Updater/* -DestinationPath yt_updater_${{ github.ref_name }}.zip -Force

      # GitHub Release
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          body: |
            ğŸ“¦ ë¦´ë¦¬ìŠ¤ ì•ˆë‚´

            ë©”ì¸ í”„ë¡œê·¸ë¨: yt_downloader_${{ github.ref_name }}.zip  
            â†’ ì‹¤í–‰ íŒŒì¼ ë° DLL í¬í•¨ (Updater.exe ì œì™¸)

            ì—…ë°ì´íŠ¸ ë„êµ¬: yt_updater_${{ github.ref_name }}.zip  
            â†’ Updater.exe + DLL + json ë“± í•„ìš”í•œ ëª¨ë“  íŒŒì¼ í¬í•¨ (ë³„ë„ Asset)

            âš ï¸ ìë™ ì—…ë°ì´íŠ¸ëŠ” ë©”ì¸ ZIPë§Œ ë‹¤ìš´ë¡œë“œí•©ë‹ˆë‹¤.  
            UpdaterëŠ” ì„¤ì¹˜ í´ë”ì— í•­ìƒ ìœ ì§€ë˜ë©°, í•„ìš” ì‹œ êµì²´í•˜ì„¸ìš”.
          files: |
            yt_downloader_${{ github.ref_name }}.zip
            yt_updater_${{ github.ref_name }}.zip
          prerelease: ${{ !startsWith(github.ref, 'refs/tags/') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
