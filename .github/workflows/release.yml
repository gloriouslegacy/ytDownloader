name: Build and Release

on:
  push:
    tags:
      - "v*"  # íƒœê·¸ í‘¸ì‹œë§Œ íŠ¸ë¦¬ê±° (ì˜ˆ: v1.0.0)
  workflow_dispatch:  # GitHub UIì—ì„œ ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  build:
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: 8.0.x

      # íƒœê·¸ì—ì„œ ë²„ì „ ì¶”ì¶œ
      - name: Determine version
        id: vars
        shell: bash
        run: |
          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            base_version="${GITHUB_REF#refs/tags/v}"
            version="$base_version"
            release_name="$base_version"
          else
            version="0.0.0-dev-$(date +%Y%m%d)"
            base_version="0.0.0-dev"
            release_name="$version"
          fi
          echo "version=$version" >> $GITHUB_OUTPUT
          echo "base_version=$base_version" >> $GITHUB_OUTPUT
          echo "release_name=$release_name" >> $GITHUB_OUTPUT

      # WPF ì•± ë¹Œë“œ (ë²„ì „ ì£¼ì…)
      - name: Build (ytDownloader WPF)
        run: dotnet publish ytDownloader/ytDownloader.csproj -c Release -r win-x64 --self-contained false -o publish/ytDownloader -p:Version=${{ steps.vars.outputs.version }}

      # Updater ë¹Œë“œ
      - name: Build (Updater)
        shell: pwsh
        run: |
          dotnet build Updater/Updater.csproj -c Release -p:Version=${{ steps.vars.outputs.version }}
          New-Item -ItemType Directory -Path publish/Updater -Force
          Copy-Item "Updater/bin/Release/net8.0-windows/*" -Destination "publish/Updater/" -Recurse

      # ë¹Œë“œ ê²°ê³¼ í™•ì¸ (ë””ë²„ê¹…ìš©)
      - name: List build output
        shell: pwsh
        run: |
          Write-Host "=== ytDownloader ë¹Œë“œ ê²°ê³¼ ==="
          Get-ChildItem publish/ytDownloader -Recurse | Format-Table Name, Length, FullName
          
          Write-Host "`n=== Updater ë¹Œë“œ ê²°ê³¼ ==="
          Get-ChildItem publish/Updater -Recurse | Format-Table Name, Length, FullName

      # ë¦´ë¦¬ìŠ¤ íŒ¨í‚¤ì§€ ì¤€ë¹„
      - name: Prepare dist
        shell: pwsh
        run: |
          mkdir dist
          mkdir dist/ytDownloader
          Copy-Item publish/ytDownloader/* dist/ytDownloader/ -Recurse
          
          # Updater íŒŒì¼ë“¤ì„ updater ì„œë¸Œí´ë”ì— ë³µì‚¬
          mkdir dist/ytDownloader/updater
          Copy-Item publish/Updater/* dist/ytDownloader/updater/ -Recurse
          
          # ë¶ˆí•„ìš”í•œ íŒŒì¼ ì œê±°
          if (Test-Path dist/ytDownloader/tools) { Remove-Item dist/ytDownloader/tools -Recurse -Force }
          Get-ChildItem dist/ytDownloader -Include *.pdb -Recurse | Remove-Item -Force
          
          # âœ… zip ì´ë¦„ í•­ìƒ ê³ ì •
          Compress-Archive -Path dist/ytDownloader/* -DestinationPath ytdownloader.zip -Force

          mkdir dist/Updater
          Copy-Item publish/Updater/* dist/Updater/ -Recurse
          Compress-Archive -Path dist/Updater/* -DestinationPath ytupdater.zip -Force

          # Defender ì œì™¸ ìŠ¤í¬ë¦½íŠ¸ ì••ì¶•
          Compress-Archive -Path ytDownloaderDefenderFileExclusion.bat -DestinationPath ytDownloaderDefenderFileExclusion.zip -Force

      # Inno Setup ì„¤ì¹˜
      - name: Setup Inno Setup
        shell: pwsh
        run: |
          choco install innosetup -y
          
      # setup.iss íŒŒì¼ ìƒì„±
      - name: Create Inno Setup Script
        shell: pwsh
        run: |
          $version = "${{ steps.vars.outputs.base_version }}"
          
          @"
          #define MyAppName "ytDownloader"
          #define MyAppVersion "$version"
          #define MyAppPublisher "gloriouslegacy"
          #define MyAppURL "https://github.com/gloriouslegacy/ytDownloader"
          #define MyAppExeName "ytDownloader.exe"

          [Setup]
          AppId={{A1B2C3D4-E5F6-7890-ABCD-EF1234567890}
          AppName={#MyAppName}
          AppVersion={#MyAppVersion}
          AppPublisher={#MyAppPublisher}
          AppPublisherURL={#MyAppURL}
          AppSupportURL={#MyAppURL}
          AppUpdatesURL={#MyAppURL}
          DefaultDirName={userappdata}\{#MyAppName}\app
          DefaultGroupName={#MyAppName}
          DisableProgramGroupPage=yes
          OutputDir=.
          OutputBaseFilename=ytDownloader-setup
          Compression=lzma
          SolidCompression=yes
          WizardStyle=modern
          PrivilegesRequired=lowest
          ArchitecturesInstallIn64BitMode=x64
          UninstallDisplayIcon={app}\{#MyAppExeName}

          [Languages]
          Name: "korean"; MessagesFile: "compiler:Languages\Korean.isl"
          Name: "english"; MessagesFile: "compiler:Default.isl"

          [Tasks]
          Name: "desktopicon"; Description: "{cm:CreateDesktopIcon}"; GroupDescription: "{cm:AdditionalIcons}"; Flags: unchecked
          Name: "quicklaunchicon"; Description: "{cm:CreateQuickLaunchIcon}"; GroupDescription: "{cm:AdditionalIcons}"; Flags: unchecked; OnlyBelowVersion: 6.1; Check: not IsAdminInstallMode

          [Files]
          Source: "publish\ytDownloader\*"; DestDir: "{app}"; Flags: ignoreversion recursesubdirs createallsubdirs

          [Icons]
          Name: "{group}\{#MyAppName}"; Filename: "{app}\{#MyAppExeName}"
          Name: "{group}\{cm:UninstallProgram,{#MyAppName}}"; Filename: "{uninstallexe}"
          Name: "{autodesktop}\{#MyAppName}"; Filename: "{app}\{#MyAppExeName}"; Tasks: desktopicon
          Name: "{userappdata}\Microsoft\Internet Explorer\Quick Launch\{#MyAppName}"; Filename: "{app}\{#MyAppExeName}"; Tasks: quicklaunchicon

          [Run]
          Filename: "{app}\{#MyAppExeName}"; Flags: nowait postinstall

          [UninstallDelete]
          Type: filesandordirs; Name: "{userappdata}\{#MyAppName}\app"

          [Code]
          procedure CurUninstallStepChanged(CurUninstallStep: TUninstallStep);
          var
            SettingsPath: String;
            ResultCode: Integer;
          begin
            if CurUninstallStep = usPostUninstall then
            begin
              SettingsPath := ExpandConstant('{userappdata}\{#MyAppName}\settings.json');
              
              if MsgBox('ì„¤ì • íŒŒì¼ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?' + #13#10 + SettingsPath, mbConfirmation, MB_YESNO) = IDYES then
              begin
                if FileExists(SettingsPath) then
                  DeleteFile(SettingsPath);
              end;
            end;
          end;
          "@ | Out-File -FilePath setup.iss -Encoding UTF8

      # Inno Setupìœ¼ë¡œ ì„¤ì¹˜ íŒŒì¼ ìƒì„±
      - name: Build Setup Installer
        shell: pwsh
        run: |
          & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" setup.iss

      # GitHub Release ìƒì„±
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.vars.outputs.base_version }}
          name: Release ${{ steps.vars.outputs.release_name }}
          body: |
            ğŸ“¦ ë¦´ë¦¬ìŠ¤ ì•ˆë‚´

            **ì„¤ì¹˜í˜• (ê¶Œì¥)**: **ytDownloader-setup.exe**
            â†’ %appdata%\ytDownloader\appì— ìë™ ì„¤ì¹˜
            â†’ ë°”íƒ•í™”ë©´ ì•„ì´ì½˜ ìƒì„± ì˜µì…˜
            â†’ ì„¤ì • íŒŒì¼: %appdata%\ytDownloader\settings.json 

            **í¬í„°ë¸”**: **ytdownloader.zip**
            â†’ ì••ì¶• í•´ì œ í›„ ì‹¤í–‰
            â†’ ì‹¤í–‰ íŒŒì¼(ytDownloader.exe), DLL, updater í´ë” í¬í•¨

            **ì—…ë°ì´íŠ¸ ë„êµ¬**: **ytupdater.zip**
            â†’ Updater.exe ë° DLL í¬í•¨ (ìˆ˜ë™ ì—…ë°ì´íŠ¸ìš©)

            **ë””íœë” ì œì™¸ ìŠ¤í¬ë¦½íŠ¸**: **ytDownloaderDefenderFileExclusion.zip**
            â†’ Windows Defender ì œì™¸ ì„¤ì • ë°°ì¹˜ íŒŒì¼ (ê´€ë¦¬ì ê¶Œí•œ í•„ìš”)

            âš ï¸ ìë™ ì—…ë°ì´íŠ¸ëŠ” ë©”ì¸ ZIPì˜ `updater` í´ë”ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
            ë³„ë„ Updater ZIPì€ ìˆ˜ë™ êµì²´ ì‹œì—ë§Œ ì‚¬ìš©í•˜ì„¸ìš”.
          files: |
            ytDownloader-setup.exe
            ytdownloader.zip
            ytupdater.zip
            ytDownloaderDefenderFileExclusion.zip
          prerelease: ${{ !startsWith(github.ref, 'refs/tags/') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
